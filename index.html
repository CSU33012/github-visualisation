<!doctype html>
<html lang="en">

  <head>

    <!-- Required meta tags -->
    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

	  <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="style.css">

    <title>github-api-access</title>

  </head>

  <body>

  <div class="vertical-center">


       <div class="box">
 					<div class="boxcontent">
 						<div class="top"><b>User Information</b></div>
 						<div class="bottom">
               <p></p>
               <p id="username"><b>Username:</b></p>
               <p id="account-age"><b>Account-Age:</b></p>
               <p id="public-repos"><b>Public Repos:</b></p>
               <p id="private-repos"><b>Private-Repos:</b></p>
             </div>
 					</div>
          <div id="my_dataviz"></div>
 			</div>

      <input type="user" class="form-control" placeholder="username" id="userinput">

      <button type="button" class="btn btn-primary" id="myButtonBasic">Get public info</button>
      <button type="button" class="btn btn-primary" id="myButton">Get all info</button>




  </div>




    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <!-- Option 2: jQuery, Popper.js, and Bootstrap JS
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    -->

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>

    <!-- Color scale -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script type="module">

      import { request } from "https://cdn.skypack.dev/@octokit/request";

      window.onload = getCode;

      $('#myButton').on('click', function (e) {
          //your awesome code here
          console.log("hello world");
          getAdvancedData();
       })

       $('#myButtonBasic').on('click', function (e) {
           //your awesome code here
           console.log("hello world");
           getBasicData();
        })

       async function getBasicData() {
         var user = document.getElementById("userinput").value;
         var client_id = "25efd33f244c9c0ae0d6";
         var client_secret = "0afe685f276806b646fd1d61f6c930d11e2b95fe";
         console.log("fetching user data");
         const userInformation = await request("GET /users/:username", {
           client_id: "25efd33f244c9c0ae0d6",
           client_secret: "0afe685f276806b646fd1d61f6c930d11e2b95fe",
           username: user
         });
         setUsername(userInformation.data.login);
         calculateAndSetAccountAge(userInformation.data.created_at);

         const repoInformation = await request("GET /users/:username/repos", {
           client_id: "25efd33f244c9c0ae0d6",
           client_secret: "0afe685f276806b646fd1d61f6c930d11e2b95fe",
           username: user
         });

         calculateNumberOfPublicAndPrivateRepos(null, userInformation.data.public_repos);
         generateLanguagesPieChart(repoInformation.data);
       }

      async function getAdvancedData() {
        var client_id = "25efd33f244c9c0ae0d6";
        window.location.href = "https://github.com/login/oauth/authorize?client_id="+client_id+"&scope=repo"+"&login="+document.getElementById("userinput").value;

      }

      function getCode() {
        const urlParams = new URLSearchParams(window.location.search);
        var code = urlParams.get("code");
        if(code != null) {
          console.log("code received, sending request to nodejs");
          getToken(code);
        }
      }

      function getToken(code) {
        $.ajax('https://github-access.darragh.io/nodejs',   // request url
            {
              type: "POST",
              data: code,
              success: function (response) {
                if(response != "code invalid") {
                  console.log("access token received: " + response);
                  getUserData(response);
                }
              },
              error: function(err) {
                console.log(err);
              }
            }
          )
      }

      async function getUserData(accessToken) {
        console.log("fetching user data");
        const userInformation = await request("GET /user", {
          headers: {
            authorization: "token " + accessToken,
          },
        });


        setUsername(userInformation.data.login);
        calculateAndSetAccountAge(userInformation.data.created_at);

        const repoInformation = await request("GET /user/repos", {
          headers: {
            authorization: "token " + accessToken,
          },
        });

        calculateNumberOfPublicAndPrivateRepos(repoInformation.data, userInformation.data.public_repos);
        generateLanguagesPieChart(repoInformation.data);
      }

      function setUsername(username) {
        document.getElementById("username").innerHTML = "<b>Username: </b>" + username;
      }

      function calculateAndSetAccountAge(creationDate) {
        var year = creationDate.substring(0,4);
        var month = creationDate.substring(5,7);
        var day = creationDate.substring(8,10);
        document.getElementById("account-age").innerHTML = "<b>Account-Age: </b>" + Math.round((((((new Date() - new Date(parseInt(year), parseInt(month), parseInt(day)))/1000)/60)/60)/24)) + " days.";
      }

      function calculateNumberOfPublicAndPrivateRepos(repodata, numberOfPublicRepos) {
        var publicRepos=numberOfPublicRepos;
        privateRepos=0;
        if(repodata != null) {
         var privateRepos=repodata.length-numberOfPublicRepos;
        }

        document.getElementById("public-repos").innerHTML = "<b>Public Repos: </b>" + publicRepos;
        document.getElementById("private-repos").innerHTML = "<b>Private Repos: </b>" + privateRepos;
      }

      function generateLanguagesPieChart(repodata) {

        d3.select("svg").remove();

        var languages = [];
        var langfrequency = [];
        for(var i=0; i<repodata.length; i++) {
          if(languages.indexOf(repodata[i].language) == -1) {
            languages.push(repodata[i].language);
            langfrequency.push(1);
          } else {
            langfrequency[languages.indexOf(repodata[i].language)]++;
          }
        }

        var stringdata = '{'
        for(var j=0; j<languages.length; j++) {
          stringdata = stringdata + '"' + languages[j] + '"' + " :" + langfrequency[j] + ",";
        }

        var width = 450;
        var height = 450;
        var margin = 40;

        // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
        var radius = Math.min(width, height) / 2 - margin;

        // append the svg object to the div called 'my_dataviz'
        var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        // Create dummy data
        stringdata = stringdata.substring(0, stringdata.length-1);
        stringdata = stringdata + '}';
        console.log(stringdata);
        var data = JSON.parse(stringdata);

        // set the color scale
        var color = d3.scaleOrdinal()
        .domain(data)
        .range(d3.schemeSet2);

        // Compute the position of each group on the pie:
        var pie = d3.pie()
        .value(function(d) {return d.value; })
        var data_ready = pie(d3.entries(data))
        // Now I know that group A goes from 0 degrees to x degrees and so on.

        // shape helper to build arcs:
        var arcGenerator = d3.arc()
        .innerRadius(0)
        .outerRadius(radius)

        // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
        svg
        .selectAll('mySlices')
        .data(data_ready)
        .enter()
        .append('path')
        .attr('d', arcGenerator)
        .attr('fill', function(d){ return(color(d.data.key)) })
        .attr("stroke", "black")
        .style("stroke-width", "2px")
        .style("opacity", 0.7)

        // Now add the annotation. Use the centroid method to get the best coordinates
        svg
        .selectAll('mySlices')
        .data(data_ready)
        .enter()
        .append('text')
        .text(function(d){ return d.data.key})
        .attr("transform", function(d) { return "translate(" + arcGenerator.centroid(d) + ")";  })
        .style("text-anchor", "middle")
        .style("font-size", 17)
        }


    </script>

  </body>

</html>
